# Ensure the backend directories are created
- name: ensure application directory is present
  file:
    state: directory
    path: /var/nodejs/{{identifier}}

# Deploy the process's application source
- include: application.yml

# Template out the nodejs config
- name: config.js template
  template:
    src: config.js
    dest: /var/nodejs/{{identifier}}/config.js

# Template out the nodejs systemd unit
- name: nodejs.service template
  template:
    src: nodejs.service
    dest: /etc/systemd/system/{{identifier}}_nodejs.service

# Always restart the nodejs server
- name: start/restart the nodejs.service
  systemd:
    daemon_reload: yes
    enabled: yes
    state: restarted
    name: "{{identifier}}_nodejs.service"

# Template out the nodejs discoverable-publishing systemd unit for {{identifier}}
- name: "{{identifier}}_route-publishing.service template"
  template:
    src: route-publishing.service
    dest: /etc/systemd/system/{{identifier}}_{{item.key}}-publishing.service
  register: node_{{item.key}}_publishing_template
  with_dict: discoverables
  when: discoverables is defined

# Start/restart the discovery publisher when discoverable and template changed
- name: start/restart the discoverable-publishing.service
  systemd:
    daemon_reload: yes
    enabled: yes
    state: restarted
    name: "{{identifier}}_{{item.key}}-publishing.service"
  with_dict: discoverables
  when: discoverables is defined and (node_{{item.key}}_publishing_template | changed)
  
# Ensure the discovery publisher is started even if template did not change
- name: start/restart the route-publishing.service
  systemd:
    daemon_reload: yes
    enabled: yes
    state: started
    name: "{{identifier}}_route-publishing.service"
  when: discoverable is defined and not (node_route_publishing_template | changed)
