# Make sure python is installed
- hosts: all:!localhost
  gather_facts: false
  become: true
  roles:
    - coreos-python

# Place a full etcd on the etcd hosts
- hosts: tag_etcd
  become: true
  roles:
    - { role: etcd, proxy_etcd: False }

# Set the etcd values (if required) from the first etcd host
- hosts: tag_etcd[0]
  become: true
  roles:
    - populate_etcd

# Place a proxy etcd everywhere except the etcd hosts
- hosts: all:!tag_etcd:!localhost
  become: true
  roles:
    - { role: etcd, proxy_etcd: True }

# Create archive of frontend content on localhost to transfer
- name: archive source
  hosts: localhost
  tasks:
    - archive:
        path: "{{frontend_src_path}}"
        dest: "{{frontend_src_path}}/../frontendsrc.tgz"

# nginx
- hosts: tag_frontend
  become: true
  roles:
    - frontend

# Create archive of backendend content on localhost to transfer, copy and edit if there are additional backend processes
- name: archive backend source
  hosts: localhost
  tasks:
    - archive:
        path: "{{backend_src_path}}"
        dest: "{{backend_src_path}}/../backendsrc.tgz"

# Default Backend Process, copy and edit if there are additional backendprocesses
- hosts: tag_backend
  become: true
  roles:
    - { role: nodejs, route: backend, strip_route: True, authenticate_route: False, config_key: backend, }
